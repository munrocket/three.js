<!DOCTYPE html>
<html lang="en">
	<head>
		<title>uuid benchmark</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>body {background-color: #cce0ff;color: #000;}</style>
	</head>

	<body>
		<div style="margin: 20px;">
			<button type="button" onclick="start();">Start benchmark!</button>
			<p>previous: <span id='math'></span></p>
			<p>new: <span id='crypto'></span></p>
		</div>

		<script>
			const _lut = [];
			for ( let i = 0; i < 256; i ++ ) {
				_lut[ i ] = ( i < 16 ? '0' : '' ) + ( i ).toString( 16 );
			}
			function getMath() {
				const d0 = Math.random() * 0xffffffff | 0;
				const d1 = Math.random() * 0xffffffff | 0;
				const d2 = Math.random() * 0xffffffff | 0;
				const d3 = Math.random() * 0xffffffff | 0;
				let uuid = _lut[ d0 & 0xff ] + _lut[ d0 >> 8 & 0xff ] + _lut[ d0 >> 16 & 0xff ] + _lut[ d0 >> 24 & 0xff ] + '-'
					+ _lut[ d1 & 0xff ] + _lut[ d1 >> 8 & 0xff ] + '-' + _lut[ d1 >> 16 & 0x0f | 0x40 ] + _lut[ d1 >> 24 & 0xff ] + '-'
					+ _lut[ d2 & 0x3f | 0x80 ] + _lut[ d2 >> 8 & 0xff ] + '-' + _lut[ d2 >> 16 & 0xff ] + _lut[ d2 >> 24 & 0xff ] +
					+ _lut[ d3 & 0xff ] + _lut[ d3 >> 8 & 0xff ] + _lut[ d3 >> 16 & 0xff ] + _lut[ d3 >> 24 & 0xff ]
					
				return uuid.toUpperCase();
			}


			let _now = 0;
			let _id = 0;

			function getCrypto() {
				let now = Date.now();
				_now = ( _now === now ) ? _now : now;
				_id = ( _id + 1 ) % 0xffffffff;
				let uid = _lut[ _now >> 24 & 0xff ] + _lut[ _now >> 16 & 0xff ] + _lut[ _now >> 8 & 0xff ] + _lut[ _now & 0xff ] +
					'-' + _lut[ _id >> 24 & 0xff ] + _lut[ _id >> 16 & 0xff ] + _lut[ _id >> 8 & 0xff ] + _lut[ _id & 0xff ];
				return uid.toUpperCase();
			}

			function start() {

				let mathCount = 0, cryptoCount = 0;
				let mathSet = new Set(), cryptoSet = new Set();
				let wtf = 0, mathTime = 0, cryptoTime = 0;
				let m, c;

				while ( mathCount < 2 && cryptoCount < 2 && wtf++ < 10000 ) {

					let now = performance.now();
					m = getMath();
					mathTime += performance.now() - now;
					
					now = performance.now();
					c = getCrypto();
					cryptoTime += performance.now() - now;

					if ( mathSet.has( m ) ) {
						mathCount++;
						document.getElementById('math').innerHTML = mathCount.toString();
					} else {
						mathSet.add( m );
					}
					if ( cryptoSet.has( c ) ) {
						cryptoCount++;
						document.getElementById('crypto').innerHTML = cryptoCount.toString();
					} else {
						cryptoSet.add( c );
					}

				}


				document.getElementById('math').innerHTML = 'collision ' +  mathCount.toString() + ', time ' + mathTime.toString() + 'ms';
				document.getElementById('crypto').innerHTML = 'collision ' + cryptoCount.toString() + ', time ' + cryptoTime.toString() + 'ms';
				console.log(mathSet, cryptoSet)

			}
		</script>
	</body>
</html>
